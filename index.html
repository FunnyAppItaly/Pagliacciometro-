<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Pagliacciometro con telecamera</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {margin:0;background:#0b0b0b;font-family:Arial,sans-serif;color:white;display:flex;justify-content:center;align-items:center;height:100vh;}
.app {width:360px;background:#151515;border-radius:24px;padding:16px;box-shadow:0 0 40px rgba(255,0,0,.35);text-align:center;}
#radar {width:260px;height:260px;margin:14px auto;border-radius:50%;background:radial-gradient(circle,#222 40%,#111 75%),repeating-radial-gradient(circle,rgba(255,0,0,.15) 0 2px,transparent 2px 22px);position:relative;overflow:hidden;}
#line {position:absolute;width:50%;height:3px;background:red;top:50%;left:50%;transform-origin:left center;box-shadow:0 0 12px red;}
.clown {width:12px;height:12px;background:red;border-radius:50%;position:absolute;box-shadow:0 0 10px red;}
button {width:100%;padding:10px;border-radius:20px;border:none;background:#ff2d2d;color:white;font-size:14px;margin-top:8px;}
#status {margin-top:10px;min-height:40px;font-weight:bold;}
.meter {height:16px;background:#333;border-radius:10px;overflow:hidden;margin:10px 0;}
.fill {height:100%;width:0%;background:green;transition:all .4s;}
#video {display:none;}
</style>
</head>

<body>
<div class="app">
  <h3>ðŸ§­ Pagliacciometro</h3>
  <video id="video" autoplay playsinline></video>
  <div id="radar">
    <div id="line"></div>
  </div>
  <div class="meter"><div class="fill" id="fill"></div></div>
  <button onclick="scan()">SCANSIONA AREA</button>
  <div id="status"></div>
</div>

<audio id="bip1" src="https://www.soundjay.com/button/sounds/button-3.mp3"></audio>
<audio id="bip2" src="https://www.soundjay.com/button/sounds/button-10.mp3"></audio>
<audio id="alarm" src="https://www.soundjay.com/misc/sounds/alarm-clock-1.mp3"></audio>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.2.0"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.2"></script>

<script>
const line = document.getElementById("line");
const radar = document.getElementById("radar");
const status = document.getElementById("status");
const fill = document.getElementById("fill");
const video = document.getElementById("video");

const bip1 = document.getElementById("bip1");
const bip2 = document.getElementById("bip2");
const alarm = document.getElementById("alarm");

const phrases = [
  "Sorriso e red flag, combo letale",
  "Troppo carino per essere vero, infattiâ€¦",
  "Radar attento, il clown Ã¨ vicino",
  "Bip bipâ€¦ attenzione alla pagliacceria!",
  "Segnale rosso: circo in arrivo!"
];

let clownAngle = Math.random() * 360;
let model;

// Bussola
if(window.DeviceOrientationEvent){
  window.addEventListener("deviceorientation", e=>{
    if(e.alpha!==null) line.style.transform=`rotate(${e.alpha}deg)`;
  });
}

// Inizializza la camera e modello
async function initCamera(){
  const stream = await navigator.mediaDevices.getUserMedia({video:true});
  video.srcObject = stream;
  model = await cocoSsd.load();
  detectFrame();
}

// Rilevamento persone
async function detectFrame(){
  if(!model) return;
  const predictions = await model.detect(video);
  let people = predictions.filter(p=>p.class==="person").length;

  // Aggiorna contachilometri / radar
  fill.style.width = Math.min(100, people*25)+"%";
  fill.style.background = people<2?"green":people<4?"orange":"red";

  // Bip e frasi
  if(people<2) bip1.play();
  else if(people<4) bip2.play();
  else alarm.play();

  status.innerText = people>0?phrases[Math.floor(Math.random()*phrases.length)]:"Radar pulito.";

  setTimeout(detectFrame, 800); // cicla ogni 0.8s
}

// Pulsante manuale
function scan(){
  detectFrame();
}

// Avvio
initCamera();
</script>
</body>
</html>
